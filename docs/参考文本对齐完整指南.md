# 参考文本对齐完整指南

## 为什么参考文本如此重要？

你的观察是完全正确的：**没有参考文本，模型会生成乱码或错误的语言**。

### 参考文本的作用

1. **语言控制**：告诉模型应该生成什么语言
2. **内容引导**：提供语义和语法的上下文
3. **音色信息**：配合音频特征，提供完整的音色信息

### 为什么"仅音频"模式失败？

- 音频特征只包含音色信息（音高、音色、共振峰）
- 不包含语言信息（词汇、语法、语义）
- 模型不知道应该生成什么语言，就会乱说

## 对齐的重要性

**参考文本必须与音频内容100%匹配**，否则：

| 情况 | 结果 |
|------|------|
| 文本 > 音频 | 模型"记住"了完整文本，会复读 |
| 文本 < 音频 | 模型缺少信息，生成质量下降 |
| 文本 ≠ 音频 | 模型困惑，生成乱码或错误语言 |
| 文本 = 音频 | ✅ 完美对齐，最佳效果 |

## 对齐验证工具

### 1. 验证当前对齐情况

```bash
python verify_alignment.py
```

输出示例：
```
音色                   时长       词数     容量     比例       状态              评分
------------------------------------------------------------------------------------------
kazakh_man_1         3.32     8      8.3    0.96     ✅ 对齐良好          100
myself               5.00     0      12.5   0.00     ❌ 空文本           0
trump                3.83     15     9.6    1.57     ❌ 文本过长          30
```

### 2. 对齐标准

**理想比例**：0.8 - 1.1（参考文本词数 / 估计容量）

- **100分**：比例在 0.6-1.1，对齐良好
- **80分**：比例在 0.4-0.6 或 1.1-1.3，略有偏差
- **60分**：比例 < 0.4，文本过短
- **30分**：比例 > 1.3，文本过长
- **0分**：参考文本为空

## 修复方法

### 方法1：自动识别（推荐）

使用 Whisper 自动识别音频内容：

```bash
# 安装 Whisper
pip install openai-whisper

# 运行识别工具
python transcribe_audio.py
```

优点：
- ✅ 自动识别，省时省力
- ✅ 准确度高（90%+）
- ✅ 支持多语言

缺点：
- ⚠️ 需要安装额外依赖
- ⚠️ 首次运行需要下载模型

### 方法2：手动对齐

手动听音频并输入参考文本：

```bash
python manual_align_text.py
```

步骤：
1. 选择音色
2. 播放音频（voices/音色名/ref.wav）
3. 听清楚内容
4. 输入音频中实际说的内容
5. 保存

优点：
- ✅ 100%准确（如果你听得准）
- ✅ 不需要额外依赖
- ✅ 可以处理 Whisper 识别不准的情况

缺点：
- ⚠️ 需要手动操作
- ⚠️ 需要听清楚音频内容

### 方法3：使用预设修复

如果你确定音频内容，可以直接运行：

```bash
python final_fix_voices.py
```

这个脚本会：
1. 修复音频格式
2. 设置预设的参考文本
3. 验证对齐情况

⚠️ 注意：预设的参考文本可能不准确，建议先播放音频确认。

## 当前问题音色的修复

### english_man_1

**问题**：参考文本为空

**音频文件**：`voices/english_man_1/ref.wav`（5秒）

**建议参考文本**（需要你确认）：
```
Welcome to the multilingual text to speech system.
```

**修复步骤**：
1. 播放音频，听清楚内容
2. 如果内容正确，运行 `python final_fix_voices.py`
3. 如果内容不对，运行 `python manual_align_text.py` 手动输入

### myself

**问题**：参考文本为空

**音频文件**：`voices/myself/ref.wav`（5秒）

**原始文本**（17词，太长）：
```
тек сенің түріңді ғана емес, дауысыңды да ұрлай аламын. Мұны қасыңдағы адамдарға, әсіресе қарттарға, міндетті түрде жібер.
```

**建议参考文本**（假设是中间部分，需要你确认）：
```
дауысыңды да ұрлай аламын. Мұны қасыңдағы адамдарға, әсіресе қарттарға.
```

**修复步骤**：
1. 播放音频，听清楚内容
2. 确定音频说的是哪部分
3. 运行 `python manual_align_text.py` 手动输入正确内容

### trump

**问题**：参考文本过长（15词，音频只有3.83秒）

**音频文件**：`voices/trump/ref.wav`（3.83秒）

**当前文本**（15词，太长）：
```
President Xi has been extremely generous with what he said. I like him a lot.
```

**建议参考文本**（假设是后半部分，需要你确认）：
```
I like him a lot. I have a great relationship with him.
```

**修复步骤**：
1. 播放音频，听清楚内容
2. 确定音频说的是哪部分
3. 运行 `python manual_align_text.py` 手动输入正确内容

## 验证修复效果

修复后，运行验证工具：

```bash
python verify_alignment.py
```

预期结果：
```
音色                   时长       词数     容量     比例       状态              评分
------------------------------------------------------------------------------------------
english_man_1        5.00     8      12.5   0.64     ✅ 对齐良好          100
myself               5.00     10     12.5   0.80     ✅ 对齐良好          100
trump                3.83     10     9.6    1.04     ✅ 对齐良好          100
```

## 测试修复效果

修复后，重启应用并测试：

```bash
python web_app.py
```

测试步骤：
1. 选择修复的音色（如 myself）
2. 输入测试文本：`Сәлем! Бұл жаңа мәтін.`
3. 点击"开始合成"

预期结果：
- ✅ 正确生成哈萨克语内容
- ✅ 不会复读参考文本
- ✅ 保留音色特征
- ✅ 语言正确，不是乱码

## 创建新音色的最佳实践

为了避免将来出现对齐问题：

### 1. 录制要求

- **时长**：3-5秒（不超过5秒）
- **内容**：清晰、简短的句子（5-10词）
- **质量**：无背景噪音，发音清晰
- **格式**：44100Hz, 单声道, WAV

### 2. 参考文本要求

- **准确性**：必须与音频内容100%匹配
- **完整性**：不能多也不能少
- **标点符号**：包含正确的标点符号

### 3. 验证步骤

1. 录制音频
2. 听一遍，确认内容
3. 写下参考文本
4. 再听一遍，对照参考文本
5. 运行 `python verify_alignment.py` 验证
6. 测试生成效果

## 工具清单

| 工具 | 用途 | 命令 |
|------|------|------|
| verify_alignment.py | 验证对齐情况 | `python verify_alignment.py` |
| transcribe_audio.py | 自动识别音频 | `python transcribe_audio.py` |
| manual_align_text.py | 手动对齐 | `python manual_align_text.py` |
| final_fix_voices.py | 批量修复 | `python final_fix_voices.py` |

## 总结

1. **参考文本是必需的**：没有参考文本，模型会生成乱码
2. **对齐是关键**：参考文本必须与音频内容100%匹配
3. **验证很重要**：使用工具验证对齐情况
4. **修复有方法**：自动识别或手动对齐

现在你有完整的工具链来确保参考文本和音频100%对齐！
