# 音色管理完整指南

## 功能概览

音色管理中心提供完整的 CRUD（增删改查）功能，让你可以：

- 📋 **查看**: 查看所有音色的状态和详细信息
- ➕ **创建**: 创建新的音色预设
- ✏️ **编辑**: 修改参考文本和更新音频文件
- 🗑️ **删除**: 删除不需要的音色

## 访问方式

1. 打开应用：http://localhost:7870
2. 点击 **"🔧 音色管理 Voice Management"** 标签页
3. 选择对应的子标签页进行操作

---

## 📋 音色列表

### 功能说明

查看所有音色的对齐状态，快速识别需要修复的音色。

### 状态表格说明

| 列名 | 说明 |
|------|------|
| 音色 | 音色名称 |
| 时长 | 参考音频时长（秒） |
| 词数 | 参考文本的词数 |
| 容量 | 估计容量（时长 × 2.5 词/秒） |
| 比例 | 词数/容量（理想值：0.8-1.1） |
| 状态 | 对齐状态（✅/⚠️/❌） |
| 评分 | 对齐评分（0-100） |

### 状态含义

- ✅ **对齐良好** (100分): 比例在 0.6-1.1，可以正常使用
- ⚠️ **文本略长/略短** (80分): 比例在 0.4-0.6 或 1.1-1.3，可能有轻微问题
- ❌ **文本过长** (30分): 比例 > 1.3，会导致复读参考文本
- ❌ **文本过短** (60分): 比例 < 0.4，可能遗漏内容
- ❌ **空文本** (0分): 没有参考文本，会生成乱码

### 操作

- 点击 **"🔄 刷新状态"** 按钮更新表格

---

## ➕ 创建音色

### 功能说明

创建新的音色预设，用于语音合成。

### 操作步骤

1. **输入音色名称**
   - 只能包含字母、数字、下划线
   - 不要使用空格或特殊字符
   - 例如：`my_voice_1`, `kazakh_female_1`

2. **上传参考音频**
   - 时长：3-10秒（推荐5秒左右）
   - 格式：WAV（推荐）或其他常见音频格式
   - 质量：清晰无噪音，发音清楚
   - 内容：简短的句子或短语

3. **输入参考文本**
   - 必须与音频内容100%一致
   - 不能多也不能少
   - 包括正确的标点符号
   - 词数应该接近 `时长 × 2.5`

4. **点击创建**
   - 系统会自动验证对齐情况
   - 显示创建结果和对齐评分

### 注意事项

- ⚠️ 音色名称不能重复
- ⚠️ 参考文本是必填项
- ⚠️ 创建后会自动验证对齐，如果评分低请修改参考文本

### 示例

**英文音色**:
- 名称: `english_man_2`
- 音频: 5秒，说 "Hello, this is a test of the voice cloning system."
- 参考文本: `Hello, this is a test of the voice cloning system.`
- 词数: 10 词
- 估计容量: 12.5 词
- 比例: 0.80 ✅

**哈萨克语音色**:
- 名称: `kazakh_woman_2`
- 音频: 4秒，说 "Сәлем! Бұл дауыс клондау жүйесі."
- 参考文本: `Сәлем! Бұл дауыс клондау жүйесі.`
- 词数: 5 词
- 估计容量: 10 词
- 比例: 0.50 ⚠️（略短，但可接受）

---

## ✏️ 编辑音色

### 功能说明

修改现有音色的参考文本或更新音频文件。

### 编辑参考文本

#### 操作步骤

1. **选择音色**
   - 从下拉菜单选择要编辑的音色
   - 系统会自动加载音色信息

2. **播放音频**
   - 点击音频播放器播放参考音频
   - 仔细听清楚音频内容
   - 可以多听几遍

3. **修改参考文本**
   - 在文本框中修改参考文本
   - 确保与音频内容100%一致

4. **保存**
   - 点击 **"💾 保存参考文本"** 按钮
   - 系统会自动验证对齐情况
   - 显示保存结果和新的对齐评分

#### 提示

- 系统会显示当前音色的详细信息（时长、词数、建议词数等）
- 参考这些信息调整参考文本
- 保存前会自动备份旧的参考文本

### 更新音频文件

#### 操作步骤

1. **选择音色**
   - 从下拉菜单选择要更新的音色

2. **展开"🔄 更新音频文件"**
   - 点击折叠面板展开

3. **上传新音频**
   - 上传新的参考音频文件
   - 确保音频质量良好

4. **更新**
   - 点击 **"🔄 更新音频"** 按钮
   - 系统会自动备份旧音频

5. **检查参考文本**
   - 更新音频后，参考文本可能不再匹配
   - 请重新检查并修改参考文本

#### 注意事项

- ⚠️ 更新音频后，旧音频会备份为 `ref.wav.backup`
- ⚠️ 更新音频后必须检查参考文本是否仍然匹配
- ⚠️ 如果更新失败，系统会自动恢复备份

---

## 🔍 查看详情

### 功能说明

查看音色的详细信息，包括音频信息、参考文本、元数据等。

### 操作步骤

1. **选择音色**
   - 从下拉菜单选择要查看的音色

2. **查看信息**
   - 音频信息：时长、采样率、声道
   - 参考文本：词数、建议词数、对齐比例
   - 对齐状态：状态和评分
   - 元数据：完整的 JSON 元数据

3. **播放音频**
   - 可以播放参考音频

### 显示内容

```
### 音色详情: kazakh_man_1

**音频信息**:
- 时长: 3.32 秒
- 采样率: 44100 Hz
- 声道: 1

**参考文本**:
- 词数: 8
- 建议词数: 8.3
- 对齐比例: 0.96

**对齐状态**: ✅ 对齐良好
**评分**: 100/100

**元数据**:
```json
{
  "name": "kazakh_man_1",
  "ref_text": "Сәлем! Бұл дауыс синтезі жүйесі.",
  "_manually_aligned": true
}
```
```

---

## 🗑️ 删除音色

### 功能说明

删除不需要的音色预设。

### 操作步骤

1. **选择音色**
   - 从下拉菜单选择要删除的音色

2. **确认删除**
   - 勾选 **"我确认要删除此音色（不可恢复）"** 复选框

3. **删除**
   - 点击 **"🗑️ 删除音色"** 按钮
   - 系统会删除整个音色目录

### 警告

⚠️ **删除操作不可恢复！**

删除音色会：
- 删除音频文件（`ref.wav`）
- 删除元数据（`meta.json`）
- 删除整个音色目录
- 删除所有备份文件

请谨慎操作！

### 安全机制

- 必须勾选确认框才能删除
- 删除后会自动刷新音色列表
- 删除后确认框会自动取消勾选

---

## 对齐标准详解

### 为什么对齐如此重要？

参考文本必须与音频内容100%匹配，否则会导致：

1. **复读参考文本**
   - 如果参考文本比音频长，模型会"记住"完整文本
   - 生成时会复读参考文本中的额外内容

2. **生成乱码**
   - 如果参考文本为空或不匹配，模型不知道应该生成什么语言
   - 会生成不知道什么语言的乱码

3. **音色克隆失败**
   - 参考文本提供语言和语义信息
   - 没有正确的参考文本，音色克隆无法正常工作

### 对齐计算公式

```
对齐比例 = 参考文本词数 / (音频时长 × 2.5)
```

**说明**:
- 2.5 是平均语速（词/秒）
- 英文：按空格分隔计数
- 中文：按字计数
- 哈萨克语：按空格分隔计数

### 理想比例

- **0.8 - 1.1**: 完美对齐
- **0.6 - 0.8**: 略短，但可接受
- **1.1 - 1.3**: 略长，但可接受
- **< 0.6**: 过短，可能遗漏内容
- **> 1.3**: 过长，会导致复读

### 评分标准

| 比例范围 | 评分 | 状态 | 说明 |
|---------|------|------|------|
| 0.6 - 1.1 | 100 | ✅ 对齐良好 | 可以正常使用 |
| 0.4 - 0.6 或 1.1 - 1.3 | 80 | ⚠️ 略有偏差 | 可能有轻微问题 |
| < 0.4 | 60 | ❌ 文本过短 | 可能遗漏内容 |
| > 1.3 | 30 | ❌ 文本过长 | 会导致复读 |
| 空文本 | 0 | ❌ 空文本 | 会生成乱码 |

---

## 常见问题

### Q1: 创建音色时，如何确定参考文本？

**A**: 
1. 播放音频，仔细听清楚内容
2. 逐字逐句写下音频中说的内容
3. 包括正确的标点符号
4. 不要添加音频中没有的内容
5. 不要遗漏音频中有的内容

### Q2: 对齐评分低怎么办？

**A**:
1. 检查参考文本是否与音频100%一致
2. 播放音频，确认没有遗漏或多余的内容
3. 检查词数是否接近建议词数
4. 如果确认无误但评分仍低，可能需要重新录制音频

### Q3: 可以使用长音频吗？

**A**:
- 不推荐。参考音频应该在 3-10 秒之间
- 过长的音频会导致对齐困难
- 推荐 5 秒左右的清晰短句

### Q4: 参考文本可以是多语言混合吗？

**A**:
- 可以，但不推荐
- 最好使用单一语言的参考音频
- 如果需要多语言，确保参考文本准确反映音频内容

### Q5: 删除音色后可以恢复吗？

**A**:
- 不可以。删除操作是永久性的
- 删除前请确认不再需要该音色
- 如果不确定，可以先备份音色目录

### Q6: 更新音频后，参考文本需要修改吗？

**A**:
- 是的！更新音频后，参考文本可能不再匹配
- 必须重新检查并修改参考文本
- 确保参考文本与新音频100%一致

### Q7: 如何批量创建音色？

**A**:
- 目前只支持逐个创建
- 如果需要批量创建，可以：
  1. 准备好音频文件和参考文本
  2. 使用脚本批量创建（需要编程）
  3. 或者逐个通过界面创建

### Q8: 音色名称有什么限制？

**A**:
- 只能包含字母、数字、下划线
- 不能包含空格或特殊字符
- 不能与现有音色重名
- 推荐使用有意义的名称，如 `kazakh_male_1`

---

## 最佳实践

### 创建高质量音色

1. **录制音频**
   - 使用好的麦克风
   - 安静的环境，无背景噪音
   - 清晰的发音
   - 自然的语速
   - 3-5秒的简短句子

2. **准备参考文本**
   - 先录音，再写参考文本
   - 播放音频，逐字逐句写下内容
   - 包括正确的标点符号
   - 多听几遍确认准确

3. **验证对齐**
   - 创建后检查对齐评分
   - 如果评分低，修改参考文本
   - 确保评分在 80 分以上

4. **测试音色**
   - 切换到合成标签页
   - 使用新音色生成测试音频
   - 检查音色是否正确
   - 检查是否有复读或乱码

### 维护音色库

1. **定期检查**
   - 定期查看音色列表
   - 修复评分低的音色
   - 删除不再使用的音色

2. **备份重要音色**
   - 手动备份音色目录
   - 保存音频文件和元数据
   - 防止意外删除

3. **命名规范**
   - 使用统一的命名规范
   - 例如：`{语言}_{性别}_{编号}`
   - 便于管理和查找

---

## 总结

音色管理中心提供了完整的 CRUD 功能：

- ✅ **查看**: 快速查看所有音色状态，识别问题
- ✅ **创建**: 轻松创建新音色，自动验证对齐
- ✅ **编辑**: 修改参考文本，更新音频文件
- ✅ **删除**: 安全删除不需要的音色

**关键要点**:
1. 参考文本必须与音频内容100%匹配
2. 对齐比例应在 0.8-1.1 之间
3. 定期检查和维护音色库
4. 删除操作不可恢复，请谨慎

现在就打开应用，开始管理你的音色库吧！

🔗 **访问地址**: http://localhost:7870
📂 **音色目录**: `voices/`
